# WorkOS B2B Template Architecture Understanding

## Core Architecture Patterns

### Authentication Flow
**WorkOS AuthKit** provides the complete auth infrastructure:
- **OAuth Code Flow + PKCE** - Handles Google, Microsoft, GitHub providers
- **SSO/SAML** - Enterprise authentication
- **Session Management** - Secure cookie-based sessions
- **Role-Based Access Control** - Admin vs user permissions

**Key Pattern**: Authentication is handled entirely by WorkOS, not custom JWT logic

### Data Architecture
**Convex as Backend** with webhook synchronization:
- **User Data Sync** - WorkOS webhooks → Convex user records
- **Organization Sync** - WorkOS org events → Convex org records
- **Real-time Updates** - Convex mutations triggered by webhook events

**Key Pattern**: Convex is the source of truth for application data, WorkOS for auth data

### Application Structure
**Next.js App Router** with server/client component patterns:
```
src/app/
├── page.tsx                    # Landing page (public)
├── pricing/page.tsx            # Pricing (public) 
├── callback/route.ts           # OAuth callback handler
├── dashboard/                  # Admin-only section
│   ├── layout.tsx             # Auth protection wrapper
│   ├── page.tsx               # Dashboard home
│   ├── users/page.tsx         # User management
│   ├── settings/page.tsx      # Org settings
│   └── audit-logs/page.tsx    # Audit logs (enterprise)
└── product/page.tsx           # User product area
```

**Key Pattern**: Layout-level auth protection, role-based routing

## Integration Points

### 1. WorkOS → Convex Webhook Sync
**Events Handled**:
- `user.created` → Create user in Convex
- `user.updated` → Update user in Convex  
- `user.deleted` → Delete user in Convex
- `organization.created` → Create org in Convex
- `organization.updated` → Update org in Convex
- `organization.deleted` → Delete org in Convex

**Implementation**: `/convex/workos.ts` handles webhook events

### 2. Stripe → Convex Billing Sync  
**Events Handled**:
- `checkout.session.completed` → Update subscription status

**Implementation**: `/convex/stripe.ts` handles billing events

### 3. AuthKit → Next.js Session
**Session Pattern**:
```typescript
// Server Component
import { getAuth } from '@workos-inc/authkit-nextjs';

const { user, session } = await getAuth();
if (!user) redirect('/');
```

**Key Pattern**: Server-side auth checking, no client-side token management

### 4. Convex → Next.js Data
**Data Fetching Pattern**:
```typescript
// Client Component
'use client';
import { useQuery } from 'convex/react';
import { api } from '../convex/_generated/api';

const users = useQuery(api.users.list);
```

**Key Pattern**: Real-time reactive queries, no REST API layer

## Schema Design Philosophy

### Minimal Auth Schema
```typescript
// They only store WorkOS mapping
users: defineTable({
  email: v.string(),
  workos_id: v.string(),
})

organizations: defineTable({
  workos_id: v.string(), 
  name: v.string(),
})
```

**Key Insight**: They rely on WorkOS as the authoritative source for user data, Convex just maps IDs

### Application Data Strategy
- **User profiles** → WorkOS handles via AuthKit
- **Billing data** → Stripe handles, sync status to Convex
- **Application data** → Convex native tables

## Environment Variable Strategy

### Local Development (`.env.local`)
```bash
# WorkOS Auth
WORKOS_API_KEY=sk_test_...
WORKOS_CLIENT_ID=client_...
NEXT_PUBLIC_WORKOS_REDIRECT_URI=http://localhost:3000/callback
WORKOS_COOKIE_PASSWORD=<64-char-hex>

# Stripe Billing  
STRIPE_API_KEY=sk_test_...

# Generated by Convex
NEXT_PUBLIC_CONVEX_URL=https://...convex.cloud
```

### Convex Cloud Environment
```bash
# Set via: npx convex env set KEY value
WORKOS_API_KEY=sk_test_...
WORKOS_WEBHOOK_SECRET=<webhook-secret>
STRIPE_API_KEY=sk_test_...
STRIPE_WEBHOOK_SECRET=<endpoint-secret>
```

**Key Pattern**: Auth/billing secrets in Convex cloud, frontend config in Next.js env

## Version Dependencies

### Critical Version Gaps
- **Convex**: Template uses 1.15.0, we use 1.25.2 (major gap)
- **AuthKit**: Template uses 0.16.1 (current)
- **Next.js**: Template uses 15.2.3 (current)

**Risk Assessment**: Convex version gap could cause compatibility issues

## Business Logic Patterns

### Role-Based Access Control
```typescript
// Dashboard layout protection
const { user } = await getAuth();
if (!user) redirect('/');

// Admin-only sections  
const isAdmin = user.role === 'admin';
if (!isAdmin) redirect('/product');
```

### Billing Feature Gates
```typescript
// Enterprise feature check
const hasAuditLogs = subscription.features.includes('audit-logs');
if (!hasAuditLogs) return <UpgradePrompt />;
```

### Organization Context
```typescript
// Multi-tenant data scoping
const data = useQuery(api.data.listForOrg, { 
  orgId: user.organizationId 
});
```

## What This Means for Our Integration

### Perfect Alignment Points
1. **Convex Backend** - Same core technology
2. **B2B Auth Patterns** - Exactly what we need for team features
3. **Webhook Architecture** - Proven sync patterns
4. **Enterprise Features** - SSO, audit logs, billing ready

### Integration Challenges
1. **Convex Version Gap** - Need to test compatibility
2. **Schema Extension** - Add our AI tables to their B2B foundation  
3. **API Layer** - They use Convex queries directly, we have HTTP endpoints
4. **Auth Paradigm** - They use server components, we have stateless API

### Strategic Opportunities
1. **Team AI Features** - Their org structure perfect for team AI workflows
2. **Enterprise Sales** - SSO + audit logs unlock enterprise deals
3. **Usage-Based Billing** - Stripe integration ready for token-based pricing
4. **Compliance** - RBAC + audit logs meet enterprise security requirements

## Four Integration Approaches - Feasibility Assessment

### A1: Full Template Migration (High Compatibility)
- **Pro**: Leverage all their proven patterns
- **Con**: Major codebase restructure required
- **Complexity**: High upfront, low ongoing

### A2: Template + Bridge Layer (Medium Compatibility)  
- **Pro**: Keep our backend, gain their frontend
- **Con**: Dual deployment complexity
- **Complexity**: Medium upfront, medium ongoing

### B1: Direct Auth Integration (Medium Compatibility)
- **Pro**: Keep our structure, add their auth
- **Con**: Manual pattern adaptation required
- **Complexity**: Medium upfront, low ongoing

### B2: Auth Wrapper (Low Compatibility)
- **Pro**: Minimal changes to our codebase
- **Con**: Miss most of their value-add patterns
- **Complexity**: Low upfront, high ongoing

## Recommendation

**A1 (Full Template Migration)** appears most strategic because:
1. **Leverages their enterprise-ready patterns** completely
2. **Fastest path to B2B SaaS readiness** 
3. **Proven scalability** for team-based AI features
4. **Our AI backend transplants cleanly** into their Convex foundation

The Convex version gap is manageable risk vs the enterprise capabilities gained.